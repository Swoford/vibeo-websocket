<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibeo ‚Äî –°–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å –¥—Ä—É–∑—å—è–º–∏</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤–∏–¥–µ–æ */
        #seek-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--progress, 0%), #334155 var(--progress, 0%), #334155 100%);
            cursor: pointer;
            outline: none;
        }

        #seek-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid #ffffff;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        #seek-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 12px rgba(59, 130, 246, 1);
        }

        #seek-slider::-moz-range-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #334155;
            border: none;
        }

        #seek-slider::-moz-range-progress {
            background: #3b82f6;
            height: 6px;
            border-radius: 3px;
        }

        #seek-slider::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid #ffffff;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        #seek-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
        #volume-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, #10b981 0%, #10b981 var(--volume, 100%), #334155 var(--volume, 100%), #334155 100%);
            cursor: pointer;
            outline: none;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid #ffffff;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        #volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(16, 185, 129, 1);
        }

        #volume-slider::-moz-range-track {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #334155;
            border: none;
        }

        #volume-slider::-moz-range-progress {
            background: #10b981;
            height: 4px;
            border-radius: 2px;
        }

        #volume-slider::-moz-range-thumb {
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid #ffffff;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        #volume-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–∑—É–Ω–∫–æ–≤ */
        input[type=range] {
            cursor: pointer;
        }
            
        .msg-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: anywhere;
            word-break: normal;
            white-space: normal;
            hyphens: auto;
            display: block;
            width: fit-content;
            max-width: 100%;
        }

        /* –î–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        .flex.justify-end .msg-bubble {
            margin-left: auto;
        }

        /* –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥—Ä—É–≥–∏—Ö - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        .flex.justify-start .msg-bubble {
            margin-right: auto;
        }

        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (max-width: 768px) {
            .msg-bubble {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 0.9rem;
                overflow-wrap: break-word;
            }
        }

        #player-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #yt-player {
            width: 100%;
            height: 100%;
        }

        .controls-visible {
            transform: translateY(0) !important;
            opacity: 1 !important;
        }
        
        .controls-hidden {
            transform: translateY(100%) !important;
            opacity: 0.5 !important;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        .connection-status {
            transition: all 0.3s ease;
        }
        .connection-status.connected {
            background: #10b981;
        }
        .connection-status.connecting {
            background: #f59e0b;
        }
        .connection-status.disconnected {
            background: #ef4444;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π */
        .reactions-container {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 2px;
            touch-action: manipulation;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .reaction-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .reaction-count {
            font-weight: 500;
            font-size: 9px;
        }

        .add-reaction-btn {
            opacity: 0.3;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .add-reaction-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .reaction-picker {
            position: fixed;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            gap: 4px;
        }

        .reaction-picker-btn {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            touch-action: manipulation;
        }

        .reaction-picker-btn:hover {
            background: #334155;
            transform: scale(1.2);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –ø—Ä–∞–≤ */
        .transfer-host-btn {
            opacity: 0;
            transition: all 0.2s;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 10px;
            color: #3b82f6;
            cursor: pointer;
        }

        .user-item:hover .transfer-host-btn {
            opacity: 1;
        }

        .transfer-host-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.05);
        }

        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (max-width: 768px) {
            .msg-bubble {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            #controls-bar {
                height: 70px;
                padding: 0 12px;
            }
            
            .reaction-btn {
                padding: 3px 8px;
                font-size: 12px;
            }
            
            .add-reaction-btn {
                width: 28px;
                height: 28px;
            }

            .transfer-host-btn {
                opacity: 1;
                font-size: 9px;
                padding: 3px 6px;
            }
        }

        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ */
        .participant-slider {
            pointer-events: none;
            opacity: 0.7;
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ö–æ—Å—Ç–∞ */
        .host-slider {
            pointer-events: auto;
            opacity: 1;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
        .delete-message-btn {
            opacity: 0;
            transition: all 0.2s ease;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 10px;
            cursor: pointer;
        }

        .group:hover .delete-message-btn {
            opacity: 1;
        }

        .delete-message-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message-deleting {
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease;
        }
    </style>

    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge
        vkBridge.send('VKWebAppInit', {});
    </script>
    </style>

<!-- –§–ò–ö–° –¥–ª—è YouTube API -->
<script>
// –§–ò–ö–°: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ YouTube API
// –ó–∞–º–µ–Ω—è–µ–º –≤–∞—à —Ç–µ–∫—É—â–∏–π loadYouTubeAPI() –Ω–∞ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç:
function loadYouTubeAPI() {
    return new Promise((resolve) => {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube —Å–∏—Å—Ç–µ–º—ã...');
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É YT –æ–±—ä–µ–∫—Ç–∞
        window.YT = window.YT || {
            PlayerState: {
                UNSTARTED: -1,
                ENDED: 0,
                PLAYING: 1,
                PAUSED: 2,
                BUFFERING: 3,
                CUED: 5
            }
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ API —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        if (window.YT && window.YT.Player) {
            console.log('‚úÖ YouTube API —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            resolve();
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è Player
        window.YT.Player = window.YT.Player || class MockPlayer {
            constructor(elementId, options) {
                console.log('üé¨ –°–æ–∑–¥–∞–Ω mock YouTube –ø–ª–µ–µ—Ä');
                this.elementId = elementId;
                this.videoId = options.videoId;
                this.events = options.events || {};
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º onReady
                setTimeout(() => {
                    if (this.events.onReady) {
                        this.events.onReady({ target: this });
                    }
                }, 100);
            }
            
            loadVideoById(videoId) {
                console.log('üé¨ Mock: –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ', videoId);
                this.videoId = videoId;
                return this;
            }
            
            playVideo() { 
                console.log('‚ñ∂Ô∏è Mock: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
                return this; 
            }
            
            pauseVideo() { 
                console.log('‚è∏Ô∏è Mock: –ü–∞—É–∑–∞');
                return this; 
            }
            
            seekTo(seconds) { 
                console.log('‚è© Mock: –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –∫', seconds);
                return this; 
            }
            
            getCurrentTime() { return 0; }
            getDuration() { return 100; }
            getPlayerState() { return window.YT.PlayerState.PAUSED; }
            setVolume(volume) { console.log('üîä Mock: –ì—Ä–æ–º–∫–æ—Å—Ç—å', volume); }
        };
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π YouTube API
        const tag = document.createElement('script');
        tag.src = '/youtube-iframe-api'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
        tag.async = true;
        tag.defer = true;
        
        window.onYouTubeIframeAPIReady = function() {
            console.log('‚úÖ –ù–∞—Å—Ç–æ—è—â–∏–π YouTube API –∑–∞–≥—Ä—É–∂–µ–Ω!');
            resolve();
        };
        
        tag.onerror = () => {
            console.log('‚ö†Ô∏è YouTube API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É');
            // –í—ã–∑—ã–≤–∞–µ–º callback –¥–ª—è –∑–∞–≥–ª—É—à–∫–∏
            setTimeout(() => {
                if (window.onYouTubeIframeAPIReady) {
                    window.onYouTubeIframeAPIReady();
                }
                resolve();
            }, 100);
        };
        
        document.head.appendChild(tag);
        
        // –¢–∞–π–º–∞—É—Ç
        setTimeout(() => {
            if (!window.YT || !window.YT.Player) {
                console.log('‚è∞ –¢–∞–π–º–∞—É—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º mock API');
                tag.onerror();
            }
        }, 3000);
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É
loadYouTubeAPI().then(() => {
    console.log('üé¨ YouTube —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞');
}).catch(err => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ YouTube:', err);
});
</script>
<script>
// –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –≤ VK
if (window.location !== window.parent.location) {
    console.log('üöÄ –ó–∞–ø—É—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ iframe (–≤–µ—Ä–æ—è—Ç–Ω–æ VK)');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏
    window.addEventListener('load', () => {
        setTimeout(() => {
            window.parent.postMessage({
                type: 'VK_APP_READY',
                payload: { loaded: true, timestamp: Date.now() }
            }, '*');
        }, 1000);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
if (typeof vkBridge !== 'undefined') {
    console.log('‚úÖ VK Bridge –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
    vkBridge.send('VKWebAppInit', {})
        .then(data => console.log('VK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', data))
        .catch(err => console.error('VK –æ—à–∏–±–∫–∞:', err));
}
</script>
</head>

<body class="h-screen flex flex-col bg-[#0b1120] no-select">

<!-- Notifications -->
<div id="toast-container" class="fixed top-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

<!-- VIEW: AUTH -->
<section id="view-auth" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-purple-700">
    <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm"></div>
    
    <div class="relative glass p-8 rounded-2xl shadow-2xl max-w-md w-full text-center fade-in border-t border-white/10">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-lg shadow-blue-500/20 rotate-3">
            <i class="fa-solid fa-users text-3xl text-white"></i>
        </div>
        <h1 class="text-4xl font-bold mb-2 text-white tracking-tight">Vibeo</h1>
        <p class="text-slate-400 mb-8">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å –¥—Ä—É–∑—å—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        
        <div class="space-y-4">
            <div class="text-left">
                <label class="text-xs text-slate-400 font-medium ml-1 uppercase tracking-wider">–í–∞—à–µ –∏–º—è</label>
                <input id="username-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" class="w-full bg-slate-800/50 border border-slate-600/50 rounded-xl px-4 py-3.5 mt-1 focus:outline-none focus:border-blue-500 focus:bg-slate-800 text-white placeholder-slate-500 transition-all" required>
            </div>
            
            <div class="text-left">
                <label class="text-xs text-slate-400 font-medium ml-1 uppercase tracking-wider">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</label>
                <input id="room-code-input" type="text" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π" class="w-full bg-slate-800/50 border border-slate-600/50 rounded-xl px-4 py-3.5 mt-1 focus:outline-none focus:border-blue-500 focus:bg-slate-800 text-white placeholder-slate-500 transition-all">
            </div>

            <button id="join-room-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-blue-600/20 transition-all transform active:scale-[0.98] touch-manipulation">
                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É
            </button>
        </div>

        <p class="text-xs text-slate-500 mt-6">
            –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—ã, –ø—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        </p>
    </div>
</section>

<!-- VIEW: APP -->
<main id="view-app" class="hidden flex-grow flex flex-col md:flex-row h-full relative overflow-hidden">
    
    <!-- VIDEO AREA -->
    <div class="flex-grow flex flex-col relative bg-black">
        <!-- Header -->
        <div class="h-16 glass flex items-center justify-between px-4 md:px-6 z-20 relative">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-blue-400">
                    <i class="fa-solid fa-users"></i>
                    <span class="font-bold text-white tracking-tight hidden sm:block">Vibeo</span>
                </div>
                <div class="h-6 w-px bg-slate-700 hidden sm:block"></div>
                <div class="flex items-center gap-2 bg-slate-800/50 rounded-full pl-3 pr-1 py-1 border border-slate-700/50">
                    <span id="connection-status" class="connection-status w-2 h-2 rounded-full disconnected"></span>
                    <span id="room-code" class="text-xs font-mono text-slate-300 tracking-wider">----</span>
                    <button id="copy-room-code-btn" class="w-7 h-7 flex items-center justify-center rounded-full bg-slate-700 hover:bg-slate-600 text-slate-300 transition-colors ml-1 touch-manipulation" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥">
                        <i class="fa-regular fa-copy text-xs"></i>
                    </button>
                </div>
                <div id="users-count" class="text-xs text-slate-400 hidden sm:block">1 —É—á–∞—Å—Ç–Ω–∏–∫</div>
            </div>

            <div class="flex items-center gap-3">
                <div class="hidden md:flex items-center gap-2">
                    <span id="current-user-name" class="text-sm font-medium text-slate-300">–ì–æ—Å—Ç—å</span>
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white">U</div>
                </div>
                <button id="leave-room-btn" class="w-9 h-9 rounded-xl bg-slate-800 hover:bg-red-900/30 hover:text-red-400 text-slate-400 flex items-center justify-center transition-all touch-manipulation">
                    <i class="fa-solid fa-door-open"></i>
                </button>
                <button id="toggle-sidebar-btn" class="md:hidden w-9 h-9 rounded-xl bg-slate-800 text-white flex items-center justify-center touch-manipulation">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
        </div>

        <!-- Video Player -->
        <div class="flex-grow flex items-center justify-center relative overflow-hidden group" id="video-wrapper">
            <!-- Empty State -->
            <div id="empty-state" class="text-center p-8 z-10">
                <div class="w-24 h-24 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6 border border-slate-700">
                    <i class="fa-solid fa-play text-4xl text-slate-500 ml-2"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">–î–æ–±–∞–≤—å—Ç–µ –≤–∏–¥–µ–æ</h2>
                <p class="text-slate-400 mb-6 max-w-md mx-auto">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</p>
                <button id="focus-search-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-full font-medium transition-all shadow-lg shadow-blue-600/20 touch-manipulation">
                    –í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ
                </button>
            </div>

            <!-- YouTube Player -->
            <div id="player-container" class="absolute inset-0 w-full h-full hidden">
                <div id="yt-player"></div>
                
                <div id="loading-overlay" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden">
                    <div class="text-white text-center">
                        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full loading-spinner mb-2 mx-auto"></div>
                        <p class="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</p>
                    </div>
                </div>
            </div>
            
            <div id="video-overlay" class="absolute inset-0 z-10 cursor-pointer touch-manipulation"></div>
        </div>

        <!-- Controls -->
        <div id="controls-bar" class="h-20 glass border-t border-white/5 px-6 flex flex-col justify-center gap-1 z-20 relative transition-all duration-300 controls-hidden">
            <div class="w-full flex items-center gap-3 group">
                 <span id="time-current" class="text-xs font-mono text-slate-400 w-10 text-right">0:00</span>
                 <input id="seek-slider" type="range" min="0" max="100" value="0" step="0.1" 
       class="flex-grow h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer touch-manipulation">
                 <span id="time-total" class="text-xs font-mono text-slate-400 w-10">0:00</span>
            </div>

            <div class="flex items-center justify-between mt-1">
                <div class="flex items-center gap-4">
                    <button id="play-btn" class="w-10 h-10 bg-white hover:bg-blue-50 text-black rounded-full flex items-center justify-center transition-transform hover:scale-105 active:scale-95 touch-manipulation">
                        <i class="fa-solid fa-play ml-1"></i>
                    </button>
                    <button id="sync-btn" class="text-slate-400 hover:text-white text-xs flex items-center gap-1 touch-manipulation" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">–°–∏–Ω—Ö—Ä.</span>
                    </button>
                </div>
                
                <div class="flex items-center gap-3">
                     <i class="fa-solid fa-volume-high text-slate-400 text-xs"></i>
                     <input id="volume-slider" type="range" min="0" max="100" value="100" class="w-24 h-1 bg-slate-700 rounded-lg touch-manipulation">
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar" class="absolute md:relative inset-0 md:inset-auto z-30 md:w-96 bg-[#0f172a] md:border-l border-slate-800 flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl md:shadow-none mobile-scroll">
        
        <!-- Tabs -->
        <div class="flex border-b border-slate-800 bg-[#0b1120]">
            <button id="tab-chat-btn" class="flex-1 py-4 text-sm font-medium text-blue-500 border-b-2 border-blue-500 transition-colors bg-slate-800/30 touch-manipulation">–ß–∞—Ç</button>
            <button id="tab-search-btn" class="flex-1 py-4 text-sm font-medium text-slate-400 hover:text-slate-200 transition-colors touch-manipulation">–í–∏–¥–µ–æ</button>
            <button id="tab-users-btn" class="flex-1 py-4 text-sm font-medium text-slate-400 hover:text-slate-200 transition-colors touch-manipulation">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
        </div>

        <!-- CHAT TAB -->
        <div id="tab-chat" class="flex-grow flex flex-col h-full overflow-hidden relative">
            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-3 pb-20 mobile-scroll">
                <div class="text-center py-4">
                    <span class="bg-slate-800/80 text-slate-400 text-xs px-3 py-1 rounded-full border border-slate-700">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Vibeo!</span>
                </div>
            </div>

            <form id="chat-form" class="absolute bottom-0 left-0 right-0 p-4 bg-[#0f172a] border-t border-slate-800">
                <div class="relative">
                    <input id="chat-input" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" class="w-full bg-slate-800 text-white rounded-full pl-5 pr-12 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 placeholder-slate-500 border border-slate-700 transition-all">
                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white hover:bg-blue-500 transition-colors touch-manipulation">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- SEARCH TAB -->
        <div id="tab-search" class="hidden flex-grow flex flex-col h-full overflow-hidden">
            <div class="p-4 border-b border-slate-800 bg-[#0b1120]">
                <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Å—Å—ã–ª–æ–∫ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-300 mb-3">üé¨ –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</label>
                    <div class="flex gap-2">
                        <input 
                            id="video-url-input" 
                            type="text" 
                            placeholder="https://youtube.com/watch?v=... –∏–ª–∏ vk.com/video..." 
                            autocomplete="off"
                            class="flex-1 bg-slate-800 text-white rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 border border-slate-700 transition-all"
                        >
                        <button 
                            id="load-video-btn"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-medium transition-all flex items-center gap-2 touch-manipulation"
                        >
                            <i class="fa-solid fa-play"></i>
                            <span class="hidden sm:inline">–í–∫–ª—é—á–∏—Ç—å</span>
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è YouTube –∏ VK –≤–∏–¥–µ–æ</p>
                </div>

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-300 mb-2">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button 
                            id="youtube-example-btn"
                            class="text-left bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-lg border border-slate-700 transition-colors touch-manipulation"
                        >
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-6 bg-red-600 rounded flex items-center justify-center">
                                    <i class="fa-brands fa-youtube text-white text-xs"></i>
                                </div>
                                <div>
                                    <div class="font-medium">YouTube –ø—Ä–∏–º–µ—Ä</div>
                                    <div class="text-xs text-slate-500">Lofi hip hop radio</div>
                                </div>
                            </div>
                        </button>
                        <button 
                            id="vk-example-btn"
                            class="text-left bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-lg border border-slate-700 transition-colors touch-manipulation"
                        >
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-6 bg-[#0077FF] rounded flex items-center justify-center">
                                    <i class="fa-brands fa-vk text-white text-xs"></i>
                                </div>
                                <div>
                                    <div class="font-medium">VK Video –ø—Ä–∏–º–µ—Ä</div>
                                    <div class="text-xs text-slate-500">–î–µ–º–æ VK –≤–∏–¥–µ–æ</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
            <div class="flex-grow overflow-y-auto p-4 mobile-scroll">
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <h3 class="font-medium text-slate-200 mb-3">üìñ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h3>
                    <div class="space-y-3 text-sm text-slate-400">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-xs text-white mt-0.5">1</div>
                            <div>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ —Å YouTube –∏–ª–∏ VK</div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-xs text-white mt-0.5">2</div>
                            <div>–í—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å"</div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-xs text-white mt-0.5">3</div>
                            <div>–í–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —É –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <h4 class="font-medium text-slate-200 mb-2">üîó –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</h4>
                        <div class="text-xs text-slate-500 space-y-1">
                            <div>‚Ä¢ YouTube: youtube.com/watch?v=ID –∏–ª–∏ youtu.be/ID</div>
                            <div>‚Ä¢ VK Video: vk.com/video-123456_789 –∏–ª–∏ vk.com/video123456_789</div>
                            <div>‚Ä¢ VK Video (–Ω–æ–≤—ã–π): vkvideo.ru/video-123456_789</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- USERS TAB -->
        <div id="tab-users" class="hidden flex-grow flex flex-col h-full overflow-hidden p-4 mobile-scroll">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <ul id="users-list" class="space-y-3">
                <!-- Users injected via JS -->
            </ul>
            
            <div class="mt-6 p-4 bg-slate-800/30 rounded-xl border border-slate-700">
                <h4 class="text-sm font-medium text-slate-200 mb-2">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h4>
                <p class="text-xs text-slate-400 mb-3">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∫–æ–º–Ω–∞—Ç—ã</p>
                <button id="copy-invite-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors touch-manipulation">
                    <i class="fa-regular fa-copy mr-2"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                </button>
            </div>
        </div>
        
        <button id="close-sidebar-btn" class="md:hidden absolute top-4 right-4 w-8 h-8 bg-slate-800 rounded-full text-white z-50 shadow-lg touch-manipulation">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
</main>

<script>
// ==========================================================================
// VIBEO - –°–û–í–ú–ï–°–¢–ù–´–ô –ü–†–û–°–ú–û–¢–† –í–ò–î–ï–û (–£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
// ==========================================================================

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let ytPlayer = null;
let progressInterval = null;
let lastPlaybackUpdate = 0;
let controlsTimeout;
let ws = null;

/* ==========================================================================
   STATE MANAGEMENT
   ========================================================================== */
const State = {
    user: null,
    room: null,
    users: [],
    video: null,
    playbackState: { playing: false, time: 0 },
    isHost: false
};

/* ==========================================================================
   UI UTILITIES
   ========================================================================== */
const UI = {
    toast: (msg, type = 'success') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        
        const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
        const colors = { success: 'green', error: 'red', info: 'blue' };
        
        el.className = `glass px-4 py-3 rounded-xl text-sm text-white shadow-lg border-l-4 border-${colors[type]}-500 flex items-center gap-2 fade-in`;
        el.innerHTML = `<i class="fa-solid ${icons[type]} text-${colors[type]}-400"></i> ${msg}`;
        container.appendChild(el);
        
        setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
        }, 4000);
    },

    updateConnectionStatus: (status) => {
        const indicator = document.getElementById('connection-status');
        indicator.className = `connection-status w-2 h-2 rounded-full ${status}`;
    }
};

/* ==========================================================================
   WEBSOCKET CLIENT
   ========================================================================== */
const WSClient = {
    ws: null,
    reconnectAttempts: 0,
    maxReconnectAttempts: 5,
    reconnectDelay: 1000,

    connect: (roomCode, userId) => {
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = isProduction ? window.location.host : 'localhost:3000';
        const wsUrl = `${protocol}//${wsHost}/ws?room=${roomCode}&userId=${userId}`;
        
        WSClient.ws = new WebSocket(wsUrl);

        WSClient.ws.onopen = () => {
            console.log('WebSocket connected');
            WSClient.reconnectAttempts = 0;
            UI.updateConnectionStatus('connected');
            UI.toast('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ', 'success');
        };

        WSClient.ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            WSClient.handleMessage(message);
        };

        WSClient.ws.onclose = () => {
            console.log('WebSocket disconnected');
            UI.updateConnectionStatus('disconnected');
            
            if (WSClient.reconnectAttempts < WSClient.maxReconnectAttempts) {
                setTimeout(() => {
                    WSClient.reconnectAttempts++;
                    WSClient.connect(roomCode, userId);
                }, WSClient.reconnectDelay * WSClient.reconnectAttempts);
            }
        };

        WSClient.ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            UI.updateConnectionStatus('disconnected');
        };
    },

    handleMessage: (message) => {
        console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message.type, message);
        
        switch (message.type) {
            case 'CONNECTED':
                break;
            case 'ROOM_STATE':
                App.handleRoomState(message);
                break;
            case 'USER_JOINED':
                Users.handleUserJoined(message);
                break;
            case 'USER_LEFT':
                Users.handleUserLeft(message);
                break;
            case 'VIDEO_CHANGED':
                Player.handleVideoChanged(message);
                break;
            case 'PLAYBACK_SYNC':
                Player.handlePlaybackSync(message);
                break;
            case 'CHAT_MESSAGE':
                Chat.handleChatMessage(message);
                break;
            case 'REACTION_UPDATE':
                Chat.handleReactionUpdate(message);
                break;
            case 'HOST_CHANGED':
                Users.handleHostChanged(message);
                break;
            case 'ROOM_SYNC':
                App.handleRoomSync(message);
                break;
            case 'ERROR':
                UI.toast(`–û—à–∏–±–∫–∞: ${message.error}`, 'error');
                break;
            case 'MESSAGE_DELETED':
                Chat.handleMessageDeleted(message);
                break;
        }
    },

    send: (message) => {
        if (WSClient.ws && WSClient.ws.readyState === WebSocket.OPEN) {
            WSClient.ws.send(JSON.stringify(message));
        } else {
            console.warn('WebSocket not connected');
        }
    },

    createRoom: (user) => {
        WSClient.send({
            type: 'CREATE_ROOM',
            user: user
        });
    },

    joinRoom: (roomCode, user) => {
        WSClient.send({
            type: 'JOIN_ROOM',
            roomCode: roomCode,
            user: user
        });
    },

    changeVideo: (video) => {
        WSClient.send({
            type: 'CHANGE_VIDEO',
            video: video
        });
    },

    updatePlayback: (state) => {
        WSClient.send({
            type: 'PLAYBACK_UPDATE',
            state: state
        });
    },

    sendChatMessage: (text) => {
        WSClient.send({
            type: 'CHAT_MESSAGE',
            text: text
        });
    },

    toggleReaction: (messageId, reaction, userId) => {
        WSClient.send({
            type: 'TOGGLE_REACTION',
            messageId: messageId,
            reaction: reaction,
            userId: userId
        });
    },

    transferHost: (newHostId) => {
        WSClient.send({
            type: 'TRANSFER_HOST',
            newHostId: newHostId
        });
    },

    requestSync: () => {
        WSClient.send({
            type: 'SYNC_REQUEST'
        });
    },

    deleteMessage: (messageId) => {
        WSClient.send({
            type: 'DELETE_MESSAGE',
            messageId: messageId
        });
    }
};

/* ==========================================================================
   APP CORE
   ========================================================================== */
const App = {
    joinRoom: () => {
        console.log('‚úÖ App.joinRoom –≤—ã–∑–≤–∞–Ω!');
        const nameInput = document.getElementById('username-input');
        const roomCodeInput = document.getElementById('room-code-input');
        
        const name = nameInput.value.trim();
        const roomCode = roomCodeInput.value.trim().toUpperCase();

        if (!name) {
            UI.toast('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'error');
            return;
        }

        State.user = {
            id: Math.random().toString(36).substr(2, 9),
            name: name
        };

        App.connectWebSocket(roomCode);
    },

    connectWebSocket: (roomCode) => {
        UI.toast('üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...', 'info');
        UI.updateConnectionStatus('connecting');
        
        try {
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsHost = isProduction ? window.location.host : 'localhost:3000';
            const wsUrl = `${protocol}//${wsHost}/ws?room=${roomCode || ''}&userId=${State.user.id}`;
            
            console.log('üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫:', wsUrl);
            WSClient.ws = new WebSocket(wsUrl);

            WSClient.ws.onopen = () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                UI.toast('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');
                UI.updateConnectionStatus('connected');
                
                if (roomCode) {
                    WSClient.ws.send(JSON.stringify({
                        type: 'JOIN_ROOM',
                        roomCode: roomCode,
                        user: State.user
                    }));
                } else {
                    WSClient.ws.send(JSON.stringify({
                        type: 'CREATE_ROOM', 
                        user: State.user
                    }));
                }
            };

            WSClient.ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ:', message);
                WSClient.handleMessage(message);
            };

            WSClient.ws.onerror = (error) => {
                console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
                UI.toast('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                UI.updateConnectionStatus('disconnected');
            };

            WSClient.ws.onclose = () => {
                console.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                UI.updateConnectionStatus('disconnected');
            };
            
        } catch (error) {
            UI.toast('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            UI.updateConnectionStatus('disconnected');
        }
    },

    handleRoomState: (message) => {
        State.room = message.room;
        State.video = message.video;
        State.playbackState = message.playbackState;
        State.users = message.users;
        State.isHost = message.isHost;
        
        App.showMainInterface();
        
        if (State.video) {
            Player.loadVideo(State.video.id, State.video.title, false);
        }
        
        if (message.chatMessages) {
            message.chatMessages.forEach(msg => {
                Chat.handleChatMessage({ message: msg });
            });
        }
        
        UI.toast(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ ${State.room}`, 'success');
        Chat.addSystemMessage(`üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É ${State.room}!`);
        
        if (State.isHost) {
            Chat.addSystemMessage('–í—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã. –î–æ–±–∞–≤—å—Ç–µ –≤–∏–¥–µ–æ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä!');
        } else {
            Chat.addSystemMessage('–í—ã —É—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–Ω–∞—Ç—ã. –û–∂–∏–¥–∞–π—Ç–µ –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∏—Ç –≤–∏–¥–µ–æ.');
        }
    },

    handleRoomSync: (message) => {
        State.video = message.video;
        State.playbackState = message.playbackState;
        State.users = message.users;
        State.isHost = message.isHost;
        Users.render();
        
        if (State.video) {
            Player.loadVideo(State.video.id, State.video.title, false);
        }
    },

    showMainInterface: () => {
        document.getElementById('view-auth').classList.add('hidden');
        document.getElementById('view-app').classList.remove('hidden');
        
        document.getElementById('current-user-name').textContent = State.user.name;
        document.getElementById('room-code').textContent = State.room;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –ø–æ–ª–∑—É–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤
        const slider = document.getElementById('seek-slider');
        if (State.isHost) {
            slider.classList.add('host-slider');
            slider.classList.remove('participant-slider');
        } else {
            slider.classList.add('participant-slider');
            slider.classList.remove('host-slider');
        }
        
        Player.init();
        Users.render();
    },

    leaveRoom: () => {
        if (confirm('–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?')) {
            if (WSClient.ws) {
                WSClient.ws.close();
            }
            location.reload();
        }
    },

    switchTab: (tab) => {
        ['chat', 'search', 'users'].forEach(t => {
            document.getElementById(`tab-${t}`).classList.add('hidden');
            document.getElementById(`tab-${t}-btn`).classList.remove('text-blue-500', 'border-b-2', 'border-blue-500', 'bg-slate-800/30');
        });
        
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.getElementById(`tab-${tab}-btn`).classList.add('text-blue-500', 'border-b-2', 'border-blue-500', 'bg-slate-800/30');
    },

    toggleSidebar: () => {
        document.getElementById('sidebar').classList.toggle('translate-x-full');
    },

    focusSearch: () => {
        App.switchTab('search');
        setTimeout(() => document.getElementById('video-url-input').focus(), 100);
    },

    copyRoomCode: () => {
        navigator.clipboard.writeText(State.room);
        UI.toast('–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏.', 'success');
    }
};

/* ==========================================================================
   PLAYER CONTROLLER
   ========================================================================== */
const Player = {
    init: () => {
        console.log('üé¨ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–µ–µ—Ä–∞...');
        
        // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º fallback –¥–ª—è –Ω–∞—á–∞–ª–∞
        Player.createFallbackPlayer();
        
        // –ü–æ–∑–∂–µ –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–ª–µ–µ—Ä –µ—Å–ª–∏ API –¥–æ—Å—Ç—É–ø–µ–Ω
        setTimeout(() => {
            if (window.YT && window.YT.Player && !ytPlayer) {
                console.log('‚úÖ YouTube API –¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø–ª–µ–µ—Ä');
                try {
                    Player.createPlayer();
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–µ–µ—Ä–∞:', error);
                    Player.createFallbackPlayer();
                }
            }
        }, 1000);
    },

    createFallbackPlayer: () => {
        console.log('üîÑ –°–æ–∑–¥–∞–µ–º fallback –ø–ª–µ–µ—Ä');
        const playerContainer = document.getElementById('player-container');
        if (playerContainer) {
            playerContainer.innerHTML = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000;">
                    <div style="text-align:center;color:white;">
                        <div style="font-size:48px;margin-bottom:20px;">üé¨</div>
                        <div>–í–∏–¥–µ–æ: ${State.video ? State.video.title : '–ù–µ –≤—ã–±—Ä–∞–Ω–æ'}</div>
                        <div style="font-size:12px;margin-top:10px;opacity:0.7;">
                            YouTube –ø–ª–µ–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω<br>
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥: 
                            <a href="https://youtube.com/watch?v=${State.video ? State.video.id : ''}" 
                               target="_blank" style="color:#3b82f6;">
                               –û—Ç–∫—Ä—ã—Ç—å –≤ YouTube
                            </a>
                        </div>
                    </div>
                </div>
            `;
            playerContainer.classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }
    },
    
    createVKFallbackPlayer: (videoData) => {
        console.log('üîÑ –°–æ–∑–¥–∞–µ–º VK –≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä');
        const playerContainer = document.getElementById('player-container');
        
        if (!playerContainer) return;
        
        playerContainer.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;color:white;padding:20px;text-align:center;">
                <div style="font-size:64px;margin-bottom:20px;">üì±</div>
                <h3 style="margin-bottom:10px;color:#0077FF;font-size:24px;">${videoData.title || 'VK –≤–∏–¥–µ–æ'}</h3>
                <p style="opacity:0.7;margin-bottom:30px;max-width:600px;">
                    VK –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –î–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:<br>
                    1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ<br>
                    2. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —ç—Ç–æ –æ–∫–Ω–æ<br>
                    3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                </p>
                
                <a href="${videoData.directUrl || `https://vk.com/video${videoData.id}`}" 
                   target="_blank" 
                   style="background:#0077FF;color:white;padding:15px 30px;border-radius:10px;text-decoration:none;display:inline-flex;align-items:center;gap:12px;font-size:18px;font-weight:600;margin-top:20px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M15.07 2H8.93C3.33 2 2 3.33 2 8.93V15.07C2 20.67 3.33 22 8.93 22H15.07C20.67 22 22 20.67 22 15.07V8.93C22 3.33 20.67 2 15.07 2M18.15 16.27H16.69C16.14 16.27 15.97 15.82 15 14.83C14.12 14 13.74 13.88 13.53 13.88C13.24 13.88 13.15 13.96 13.15 14.38V15.69C13.15 16.04 13.04 16.26 12.11 16.26C10.57 16.26 8.86 15.32 7.66 13.59C5.85 11.05 5.36 9.13 5.36 8.75C5.36 8.54 5.43 8.34 5.85 8.34H7.32C7.69 8.34 7.83 8.5 7.97 8.9C8.69 10.96 10.38 13.09 11.53 13.09C11.8 13.09 11.87 13 11.87 12.66V10.84C11.87 9.5 12.01 9.41 12.41 9.41C12.71 9.41 13.18 9.53 14.54 10.94C16.01 12.57 16.3 13.08 17.08 13.08H18.56C19 13.08 19.13 13.35 18.96 13.69C18.68 14.22 17.64 15.26 16.64 16.04C16.24 16.35 15.98 16.5 15.89 16.66C15.79 16.83 15.86 17 16.12 17H18.15C18.56 17 18.7 17.18 18.7 17.41C18.7 17.76 18.3 18.31 17.63 18.95C16.8 19.74 16.19 20 15.87 20C15.62 20 15.5 19.88 15.5 19.52V18.77C15.5 17.82 15.38 17.73 14.64 17.18C13.75 16.5 12.61 15.47 11.2 13.93C9.92 12.55 9.22 11.76 8.95 11.38C8.68 11 8.76 10.8 8.95 10.56C9.06 10.43 9.27 10.2 9.46 10C10.67 8.74 11.5 7.71 12.08 6.92C12.46 6.41 12.86 6 13.45 6H14.93C15.23 6 15.36 6.16 15.45 6.45C15.55 6.79 16.06 7.87 16.63 8.92C17.14 9.84 17.55 10.42 17.73 10.42C17.86 10.42 17.93 10.32 17.93 10.05V8.93C17.93 8.5 18.05 8.34 18.44 8.34H19.93C20.28 8.34 20.41 8.55 20.28 8.9C20.07 9.42 19.03 10.67 17.63 12.04C16.99 12.65 16.57 13 16.45 13.15C16.33 13.3 16.37 13.42 16.54 13.42C17.21 13.42 18.53 12.38 19.63 11.21C20.36 10.42 21.03 9.66 21.07 9.41C21.11 9.16 20.99 9 20.64 9H19.17C18.81 9 18.69 9.11 18.57 9.38C18.43 9.68 17.77 10.65 16.93 11.58C16.36 12.21 16.06 12.42 15.98 12.42C15.86 12.42 15.79 12.33 15.79 11.95V11.25C15.79 9.85 16.32 9.72 16.53 9.72C16.68 9.72 16.9 9.79 17.32 10.19C17.77 10.61 19.08 12.11 20.26 13.53C21.14 14.56 21.8 15.36 21.86 15.57C21.93 15.84 21.8 16 21.43 16H19.93Z"/>
                    </svg>
                    –û—Ç–∫—Ä—ã—Ç—å VK –≤–∏–¥–µ–æ
                </a>
                
                <div style="margin-top:40px;font-size:14px;opacity:0.5;max-width:500px;">
                    <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                    ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ –≤ VK<br>
                    ‚Ä¢ –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —ç—Ç–æ –æ–∫–Ω–æ<br>
                    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ "‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" –∏ "‚è∏Ô∏è –ü–∞—É–∑–∞" –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –¥—Ä—É–∑—å—è–º–∏</p>
                </div>
            </div>
        `;
        
        playerContainer.classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
    },

    createPlayer: () => {
        try {
            console.log('üîÑ –°–æ–∑–¥–∞–µ–º YouTube –ø–ª–µ–µ—Ä...');
            ytPlayer = new YT.Player('yt-player', {
                height: '100%',
                width: '100%',
                videoId: State.video ? State.video.id : '',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'enablejsapi': 1
                },
                events: {
                    'onReady': (event) => {
                        console.log('‚úÖ YouTube –ø–ª–µ–µ—Ä –≥–æ—Ç–æ–≤');
                        Player.onReady(event);
                    },
                    'onStateChange': (event) => {
                        Player.onStateChange(event);
                    },
                    'onError': (error) => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ YouTube –ø–ª–µ–µ—Ä–∞:', error);
                        Player.onError(error);
                    }
                }
            });
            console.log('‚úÖ YouTube –ø–ª–µ–µ—Ä —Å–æ–∑–¥–∞–Ω');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è YouTube –ø–ª–µ–µ—Ä–∞:', error);
            Player.createFallbackPlayer();
            UI.toast('‚ö†Ô∏è –ü–ª–µ–µ—Ä –≤ —Ä–µ–∂–∏–º–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏', 'info');
        }
    },

    onReady: () => {
        console.log('Player ready');
        Player.showControls();
        Player.initVolume();
    },

    onStateChange: (event) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ YT –æ–±—ä–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (!window.YT || !window.YT.PlayerState) {
            console.warn('YT.PlayerState –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
            return;
        }
        
        const currentTime = ytPlayer ? ytPlayer.getCurrentTime() : 0;
        const now = Date.now();
        
        if (now - lastPlaybackUpdate > 500) {
            switch (event.data) {
                case window.YT.PlayerState.PLAYING:
                    if (State.isHost) {
                        WSClient.updatePlayback({ playing: true, time: currentTime });
                        lastPlaybackUpdate = now;
                    }
                    break;
                case window.YT.PlayerState.PAUSED:
                    if (State.isHost) {
                        WSClient.updatePlayback({ playing: false, time: currentTime });
                        lastPlaybackUpdate = now;
                    }
                    break;
            }
        }

        switch (event.data) {
            case window.YT.PlayerState.PLAYING:
                Player.updatePlayBtn(true);
                Player.startProgressLoop();
                Player.showLoading(false);
                break;
            case window.YT.PlayerState.PAUSED:
                Player.updatePlayBtn(false);
                break;
            case window.YT.PlayerState.BUFFERING:
                Player.showLoading(true);
                break;
            case window.YT.PlayerState.ENDED:
                Player.updatePlayBtn(false);
                break;
        }
    },

    onError: (error) => {
        console.error('YouTube Player Error:', error);
        UI.toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ.', 'error');
        Player.showLoading(false);
    },

    loadVideo: (videoId, title, broadcast = true) => {
        if (!State.isHost && broadcast) {
            UI.toast('‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –≤–∏–¥–µ–æ', 'error');
            return;
        }
        
        State.video = { id: videoId, title: title, originalId: videoId };
        
        console.log('üé¨ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ:', videoId, title);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('player-container').classList.remove('hidden');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –≤–∏–¥–µ–æ
        const isVKVideo = videoId.includes('_') && !videoId.includes('?');
        
        if (isVKVideo) {
            // –î–ª—è VK –≤–∏–¥–µ–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            console.log('üîÑ –≠—Ç–æ VK –≤–∏–¥–µ–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
            VideoLoader.loadVKVideo(State.video);
            return;
        }
        
        // –î–ª—è YouTube –≤–∏–¥–µ–æ
        if (window.YT && window.YT.Player && ytPlayer) {
            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º YouTube Player API');
            Player.showLoading(true);

            try {
                ytPlayer.loadVideoById(videoId);
                
                if (broadcast) {
                    WSClient.changeVideo(State.video);
                    Chat.addSystemMessage(`üé¨ ${State.user.name} –≤–∫–ª—é—á–∏–ª: ${title}`);
                }

                UI.toast(`üé¨ –í–∏–¥–µ–æ "${title}" –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'success');
            } catch (error) {
                console.error('Error loading video with YouTube API:', error);
                Player.createFallbackPlayer();
                UI.toast('üé¨ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Ä–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)', 'info');
            }
        } else {
            // Fallback –¥–ª—è YouTube
            console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback —Ä–µ–∂–∏–º –¥–ª—è YouTube');
            Player.createFallbackPlayer();
            
            if (broadcast) {
                WSClient.changeVideo(State.video);
                Chat.addSystemMessage(`üé¨ ${State.user.name} –≤–∫–ª—é—á–∏–ª: ${title}`);
            }
            
            UI.toast(`üé¨ –í–∏–¥–µ–æ "${title}" –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)`, 'info');
        }
    },

    handleVideoChanged: (message) => {
        if (message.userId !== State.user.id) {
            Player.loadVideo(message.video.id, message.video.title, false);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∏–¥–µ–æ
            setTimeout(() => {
                const slider = document.getElementById('seek-slider');
                if (slider) {
                    slider.value = 0;
                    slider.style.setProperty('--progress', '0%');
                    document.getElementById('time-current').textContent = '0:00';
                }
            }, 1000);
        }
    },

    handlePlaybackSync: (message) => {
        if (ytPlayer) {
            const currentTime = ytPlayer.getCurrentTime();
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 2 —Å–µ–∫—É–Ω–¥
            if (Math.abs(currentTime - message.state.time) > 2) {
                ytPlayer.seekTo(message.state.time, true);
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ø–∞—É–∑—É
            if (message.state.playing && ytPlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                ytPlayer.playVideo();
            } else if (!message.state.playing && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                ytPlayer.pauseVideo();
            }
            
            // –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú –ü–û–õ–ó–£–ù–û–ö –î–õ–Ø –í–°–ï–• –£–ß–ê–°–¢–ù–ò–ö–û–í (–í–ö–õ–Æ–ß–ê–Ø –•–û–°–¢–ê)
            const slider = document.getElementById('seek-slider');
            if (slider && document.activeElement !== slider) {
                const total = ytPlayer.getDuration();
                if (total && total !== Infinity) {
                    const progressPercent = (message.state.time / total) * 100;
                    slider.value = progressPercent;
                    slider.style.setProperty('--progress', progressPercent + '%');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                    document.getElementById('time-current').textContent = Player.formatTime(message.state.time);
                }
            }
        }
    },

    togglePlay: () => {
        if (!ytPlayer) return;
        
        // –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
        if (!State.isHost) {
            UI.toast('‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º', 'error');
            return;
        }
        
        if (ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
            ytPlayer.pauseVideo();
        } else {
            ytPlayer.playVideo();
        }
    },

    onSeekInput: (val) => {
        // –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞—Ç—å
        if (!State.isHost) {
            return;
        }
        
        const duration = ytPlayer ? ytPlayer.getDuration() : 0;
        if (duration > 0) {
            const newTime = duration * (val / 100);
            document.getElementById('time-current').textContent = Player.formatTime(newTime);
        }
    },

    onSeekChange: (val) => {
        if (!ytPlayer) return;
        
        // –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞—Ç—å
        if (!State.isHost) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –Ω–∞ —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            const current = ytPlayer.getCurrentTime();
            const total = ytPlayer.getDuration();
            if (total > 0) {
                const progressPercent = (current / total) * 100;
                const slider = document.getElementById('seek-slider');
                slider.value = progressPercent;
                slider.style.setProperty('--progress', progressPercent + '%');
            }
            UI.toast('‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞—Ç—å –≤–∏–¥–µ–æ', 'error');
            return;
        }
        
        const duration = ytPlayer.getDuration();
        const newTime = duration * (val / 100);
        ytPlayer.seekTo(newTime, true);
    },

    setVolume: (val) => {
        if (ytPlayer && ytPlayer.setVolume) {
            try {
                const volumeValue = parseInt(val);
                ytPlayer.setVolume(volumeValue);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const volumeSlider = document.getElementById('volume-slider');
                if (volumeSlider) {
                    volumeSlider.style.setProperty('--volume', volumeValue + '%');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ localStorage
                localStorage.setItem('vibeo-volume', volumeValue);
            } catch (error) {
                console.error('Error setting volume:', error);
            }
        }
    },

    initVolume: () => {
        const savedVolume = localStorage.getItem('vibeo-volume');
        const volumeSlider = document.getElementById('volume-slider');
        
        if (savedVolume) {
            volumeSlider.value = savedVolume;
            volumeSlider.style.setProperty('--volume', savedVolume + '%');
            Player.setVolume(savedVolume);
        } else {
            volumeSlider.value = 100;
            volumeSlider.style.setProperty('--volume', '100%');
            Player.setVolume(100);
        }
    },

    updatePlayBtn: (isPlaying) => {
        const btn = document.getElementById('play-btn');
        btn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play ml-1"></i>';
    },

    startProgressLoop: () => {
        if (progressInterval) clearInterval(progressInterval);
        
        progressInterval = setInterval(() => {
            if (!ytPlayer || !ytPlayer.getCurrentTime) return;
            
            try {
                const current = ytPlayer.getCurrentTime();
                const total = ytPlayer.getDuration();
                
                if (!total || total === Infinity) return;

                const slider = document.getElementById('seek-slider');
                const progressPercent = (current / total) * 100;
                
                // –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ —É —Ö–æ—Å—Ç–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                slider.value = progressPercent;
                slider.style.setProperty('--progress', progressPercent + '%');

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                document.getElementById('time-current').textContent = Player.formatTime(current);
                document.getElementById('time-total').textContent = Player.formatTime(total);
                
            } catch (error) {
                console.error('Progress update error:', error);
            }
        }, 500);
    },

    formatTime: (seconds) => {
        if (!seconds || seconds === Infinity) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    },

    showLoading: (show) => {
        const overlay = document.getElementById('loading-overlay');
        if (show) {
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    },

    showControls: () => {
        const controls = document.getElementById('controls-bar');
        controls.classList.remove('controls-hidden');
        controls.classList.add('controls-visible');
    },

    requestSync: () => {
        WSClient.requestSync();
        UI.toast('–ó–∞–ø—Ä–æ—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'info');
    }
};

/* ==========================================================================
   USERS MANAGEMENT
   ========================================================================== */
const Users = {
    handleUserJoined: (message) => {
        State.users = message.users;
        Users.render();
        Chat.addSystemMessage(`üëã ${message.user.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`);
    },

    handleUserLeft: (message) => {
        State.users = message.users;
        Users.render();
        Chat.addSystemMessage(`üö™ ${message.userName} –≤—ã—à–µ–ª`);
    },

    handleHostChanged: (message) => {
        State.users = message.users;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à —Å—Ç–∞—Ç—É—Å —Ö–æ—Å—Ç–∞
        State.isHost = State.user.id === message.newHostId;
        
        Users.render();
        
        if (State.isHost) {
            Chat.addSystemMessage(`üëë –¢–µ–ø–µ—Ä—å –≤—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã!`);
            UI.toast('üëë –í—ã —Å—Ç–∞–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º –∫–æ–º–Ω–∞—Ç—ã!', 'success');
        } else {
            Chat.addSystemMessage(`üëë ${message.newHostName} —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã`);
        }
    },

    transferHost: (newHostId) => {
        if (!State.isHost) {
            UI.toast('‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∞', 'error');
            return;
        }
        
        if (newHostId === State.user.id) {
            UI.toast('‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∞–≤–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ', 'error');
            return;
        }
        
        if (confirm('–ü–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–æ–º–Ω–∞—Ç—ã?')) {
            WSClient.transferHost(newHostId);
        }
    },

    render: () => {
        const list = document.getElementById('users-list');
        const count = document.getElementById('users-count');
        
        list.innerHTML = '';
        count.textContent = `${State.users.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
        count.classList.remove('hidden');

        State.users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-item flex items-center gap-3 p-3 rounded-xl bg-slate-800/40 border border-slate-700/50 relative';
            
            const isCurrentUser = user.id === State.user.id;
            const canTransfer = State.isHost && !user.isHost && !isCurrentUser;
            
            li.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-sm font-bold text-white">
                    ${user.name.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-slate-200 truncate flex items-center gap-2">
                        ${user.name}
                        ${user.isHost ? '<span class="text-yellow-400 text-xs">üëë</span>' : ''}
                    </div>
                    <div class="text-xs text-slate-500">${user.isHost ? '–°–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã' : '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                </div>
                ${isCurrentUser ? '<span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded">–í—ã</span>' : ''}
                ${canTransfer ? '<button class="transfer-host-btn" data-user-id="${user.id}" title="–ü–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∞–≤–∞">üëë –ü–µ—Ä–µ–¥–∞—Ç—å</button>' : ''}
            `;
            list.appendChild(li);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏ –ø—Ä–∞–≤
        document.querySelectorAll('.transfer-host-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                Users.transferHost(userId);
            });
        });
    }
};

/* ==========================================================================
   CHAT SYSTEM
   ========================================================================== */
const Chat = {
    sendMessage: (e) => {
        if (e) e.preventDefault();
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        WSClient.sendChatMessage(text);
        input.value = '';
    },

    deleteMessage: (messageId) => {
        if (!confirm(State.isHost ? '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?' : '–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            return;
        }
        
        WSClient.send({
            type: 'DELETE_MESSAGE',
            messageId: messageId
        });
    },

    handleMessageDeleted: (message) => {
        const messageElement = document.querySelector(`[data-message-id="${message.messageId}"]`);
        if (messageElement) {
            // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateX(-20px)';
            messageElement.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                messageElement.remove();
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏
                if (message.isHost) {
                    Chat.addSystemMessage(`üóëÔ∏è –°–æ–∑–¥–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ`);
                }
            }, 300);
        }
    },

    handleChatMessage: (message) => {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.setAttribute('data-message-id', message.message.id);
        
        const isMe = message.message.userId === State.user.id;
        
        if (isMe) {
            div.className = 'flex justify-end';
            div.innerHTML = Chat.createMessageHTML(message.message, true);
        } else {
            div.className = 'flex justify-start';
            div.innerHTML = Chat.createMessageHTML(message.message, false);
        }
        
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
        Chat.attachReactionHandlers(div, message.message.id);
    },

    createMessageHTML: (message, isMe) => {
        const reactionsHTML = Chat.createReactionsHTML(message.reactions, message.id);
        const canDelete = State.isHost || (isMe && !message.isSystem);
        
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –¥–ª—è —Ö–æ—Å—Ç–∞)
        const deleteButton = canDelete ? 
            `<button class="delete-message-btn" data-message-id="${message.id}" title="${State.isHost ? '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ' : '–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}">
                <i class="fa-solid fa-trash"></i>
            </button>` : '';

        if (isMe) {
            return `<div class="flex flex-col items-end max-w-[85%] group relative">
                <div class="flex items-end gap-2">
                    <div class="bg-blue-600 text-white msg-bubble rounded-tr-none shadow-lg shadow-blue-900/20">${message.text}</div>
                    ${deleteButton}
                </div>
                ${reactionsHTML}
                <span class="text-[10px] text-slate-500 mt-1">${new Date(message.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</span>
            </div>`;
        } else {
            return `<div class="flex flex-col items-start max-w-[85%] group relative">
                <div class="flex items-end gap-2">
                    <div class="bg-slate-800 text-slate-200 msg-bubble rounded-tl-none border border-slate-700">${message.text}</div>
                    ${deleteButton}
                </div>
                ${reactionsHTML}
                <span class="text-[10px] text-slate-500 ml-2 mb-1">${message.author} ${message.isHost ? 'üëë' : ''}</span>
                <span class="text-[10px] text-slate-500 ml-2 mt-1">${new Date(message.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</span>
            </div>`;
        }
    },

    createReactionsHTML: (reactions, messageId) => {
        const reactionEmojis = {
            'like': 'üëç',
            'heart': '‚ù§Ô∏è',
            'laugh': 'üòÇ',
            'wow': 'üòÆ',
            'sad': 'üò¢',
            'angry': 'üò†'
        };

        let reactionsHTML = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
        if (reactions && Object.keys(reactions).length > 0) {
            for (const [reaction, users] of Object.entries(reactions)) {
                const count = users.length;
                const hasReacted = users.includes(State.user.id);
                reactionsHTML += `
                    <button class="reaction-btn ${hasReacted ? 'active' : ''}" 
                            data-message-id="${messageId}" 
                            data-reaction="${reaction}">
                        ${reactionEmojis[reaction]}<span class="reaction-count">${count}</span>
                    </button>
                `;
            }
        }

        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏ (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
        reactionsHTML += `
            <button class="reaction-btn add-reaction-btn" data-message-id="${messageId}" title="–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é">
                <i class="fa-solid fa-face-smile text-xs"></i>
            </button>
        `;

        return `<div class="reactions-container">${reactionsHTML}</div>`;
    },

    attachReactionHandlers: (messageElement, messageId) => {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∞–∫—Ü–∏–π
        messageElement.querySelectorAll('.reaction-btn:not(.add-reaction-btn)').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const reaction = btn.dataset.reaction;
                Chat.toggleReaction(messageId, reaction);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏
        messageElement.querySelector('.add-reaction-btn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            Chat.showReactionPicker(e.target, messageId);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        messageElement.querySelector('.delete-message-btn')?.addEventListener('click', function() {
            const messageId = this.getAttribute('data-message-id');
            Chat.deleteMessage(messageId);
        });
    },

    toggleReaction: (messageId, reaction) => {
        WSClient.toggleReaction(messageId, reaction, State.user.id);
    },

    showReactionPicker: (button, messageId) => {
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∏–∫–µ—Ä
        const existingPicker = document.querySelector('.reaction-picker');
        if (existingPicker) {
            existingPicker.remove();
            return;
        }

        const picker = document.createElement('div');
        picker.className = 'reaction-picker';
        
        const reactions = {
            'like': 'üëç',
            'heart': '‚ù§Ô∏è',
            'laugh': 'üòÇ',
            'wow': 'üòÆ',
            'sad': 'üò¢',
            'angry': 'üò†'
        };

        let pickerHTML = '';
        for (const [reaction, emoji] of Object.entries(reactions)) {
            pickerHTML += `
                <button class="reaction-picker-btn" data-reaction="${reaction}">
                    ${emoji}
                </button>
            `;
        }

        picker.innerHTML = pickerHTML;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
        document.body.appendChild(picker);
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–∏–∫–µ—Ä–∞
        const pickerRect = picker.getBoundingClientRect();
        const buttonRect = button.getBoundingClientRect();
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        let left = buttonRect.left - (pickerRect.width / 2) + (buttonRect.width / 2);
        let top = buttonRect.top - pickerRect.height - 10;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –ø–∏–∫–µ—Ä –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
        if (left < 10) {
            left = 10;
        } else if (left + pickerRect.width > viewportWidth - 10) {
            left = viewportWidth - pickerRect.width - 10;
        }
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (–µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–∏–∑—É)
        if (top < 10) {
            top = buttonRect.bottom + 10;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
        picker.style.left = `${left}px`;
        picker.style.top = `${top}px`;
        picker.style.bottom = 'auto';

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        picker.querySelectorAll('.reaction-picker-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const reaction = btn.dataset.reaction;
                Chat.toggleReaction(messageId, reaction);
                picker.remove();
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        setTimeout(() => {
            const closePicker = (e) => {
                if (!picker.contains(e.target) && e.target !== button) {
                    picker.remove();
                    document.removeEventListener('click', closePicker);
                    document.removeEventListener('touchstart', closePicker);
                }
            };
            document.addEventListener('click', closePicker);
            document.addEventListener('touchstart', closePicker);
        }, 100);
    },

    handleReactionUpdate: (message) => {
        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏
        const messageElement = document.querySelector(`[data-message-id="${message.messageId}"]`);
        if (messageElement) {
            const reactionsContainer = messageElement.querySelector('.reactions-container');
            if (reactionsContainer) {
                reactionsContainer.outerHTML = Chat.createReactionsHTML(message.reactions, message.messageId);
                Chat.attachReactionHandlers(messageElement, message.messageId);
            }
        }
    },

    addSystemMessage: (text) => {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'text-center my-2';
        div.innerHTML = `<span class="text-[10px] text-slate-500 bg-slate-800/50 px-2 py-1 rounded-full">${text}</span>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
};

/* ==========================================================================
   VIDEO URL LOADER
   ========================================================================== */
const VideoLoader = {
    loadFromUrl: () => {
        const urlInput = document.getElementById('video-url-input');
        const url = urlInput.value.trim();
        
        if (!url) {
            UI.toast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ', 'error');
            return;
        }

        UI.toast('üîÑ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∏–¥–µ–æ...', 'info');

        try {
            const videoInfo = VideoLoader.parseVideoUrl(url);
            
            if (videoInfo) {
                Player.loadVideo(videoInfo.id, videoInfo.title);
                urlInput.value = '';
            } else {
                UI.toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è YouTube –∏ VK', 'error');
            }
            
        } catch (error) {
            console.error('Error loading video from URL:', error);
            UI.toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
        }
    },

    loadExample: (type) => {
        const examples = {
            youtube: {
                url: 'https://www.youtube.com/watch?v=jfKfPfyJRdk',
                title: 'Lofi hip hop radio üìö'
            },
            vk: {
                url: 'https://vk.com/video-205631275_456239152',
                title: 'VK Video Demo üé¨'
            }
        };
        
        const example = examples[type];
        document.getElementById('video-url-input').value = example.url;
        UI.toast(`‚úÖ –ü—Ä–∏–º–µ—Ä ${type} –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ`, 'info');
    },

    parseVideoUrl: (url) => {
    console.log('üîç –ü–∞—Ä—Å–∏–º URL:', url);
    
    // YouTube –ø–∞—Ä—Å–∏–Ω–≥
    const youtubeRegexes = [
        /(?:youtube\.com\/watch\?v=)([^"&?\/\s]{11})/,
        /(?:youtube\.com\/embed\/)([^"&?\/\s]{11})/,
        /(?:youtu\.be\/)([^"&?\/\s]{11})/,
        /(?:youtube\.com\/.*[?&]v=)([^"&?\/\s]{11})/
    ];
    
    for (const regex of youtubeRegexes) {
        const match = url.match(regex);
        if (match && match[1]) {
            console.log('‚úÖ –ù–∞–π–¥–µ–Ω YouTube ID:', match[1]);
            return {
                id: match[1],
                title: 'YouTube –≤–∏–¥–µ–æ',
                type: 'youtube'
            };
        }
    }

    // VK Video –ø–∞—Ä—Å–∏–Ω–≥ (—Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
    const vkRegex = /(?:vk\.com|vkvideo\.ru)\/video(-?\d+_\d+)/;
    const vkMatch = url.match(vkRegex);
    
    if (vkMatch) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω VK ID:', vkMatch[1]);
        
        // –î–ª—è VK –≤–∏–¥–µ–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        return {
            id: vkMatch[1],
            title: 'VK –≤–∏–¥–µ–æ',
            type: 'vk',
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä—è–º–æ–π URL –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
            directUrl: `https://vk.com/video${vkMatch[1]}`
        };
    }

    console.log('‚ùå –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω URL');
    return null;
},

// –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ VK –≤–∏–¥–µ–æ
loadVKVideo: async (videoData) => {
    console.log('üé¨ –ó–∞–≥—Ä—É–∑–∫–∞ VK –≤–∏–¥–µ–æ:', videoData.id);
    
    // –î–ª—è VK –≤–∏–¥–µ–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback —Å –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π
    Player.createVKFallbackPlayer(videoData);
    
    if (State.isHost) {
        WSClient.changeVideo(videoData);
        Chat.addSystemMessage(`üé¨ ${State.user.name} –≤–∫–ª—é—á–∏–ª VK –≤–∏–¥–µ–æ`);
    }
    
    UI.toast(`üé¨ VK –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'info');
},

/* ==========================================================================
   UI UTILITIES
   ========================================================================== */
const UI = {
    toast: (msg, type = 'success') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        
        const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
        const colors = { success: 'green', error: 'red', info: 'blue' };
        
        el.className = `glass px-4 py-3 rounded-xl text-sm text-white shadow-lg border-l-4 border-${colors[type]}-500 flex items-center gap-2 fade-in`;
        el.innerHTML = `<i class="fa-solid ${icons[type]} text-${colors[type]}-400"></i> ${msg}`;
        container.appendChild(el);
        
        setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
        }, 4000);
    },

    updateConnectionStatus: (status) => {
        const indicator = document.getElementById('connection-status');
        indicator.className = `connection-status w-2 h-2 rounded-full ${status}`;
    }
};

// ==========================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô
// ==========================================================================

function initializeEventListeners() {
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.getElementById('join-room-btn')?.addEventListener('click', () => App.joinRoom());
    document.getElementById('copy-room-code-btn')?.addEventListener('click', () => App.copyRoomCode());
    document.getElementById('copy-invite-btn')?.addEventListener('click', () => App.copyRoomCode());
    document.getElementById('leave-room-btn')?.addEventListener('click', () => App.leaveRoom());
    document.getElementById('toggle-sidebar-btn')?.addEventListener('click', () => App.toggleSidebar());
    document.getElementById('close-sidebar-btn')?.addEventListener('click', () => App.toggleSidebar());
    document.getElementById('focus-search-btn')?.addEventListener('click', () => App.focusSearch());
    
    // –¢–∞–±—ã
    document.getElementById('tab-chat-btn')?.addEventListener('click', () => App.switchTab('chat'));
    document.getElementById('tab-search-btn')?.addEventListener('click', () => App.switchTab('search'));
    document.getElementById('tab-users-btn')?.addEventListener('click', () => App.switchTab('users'));
    
    // –ö–Ω–æ–ø–∫–∏ –ø–ª–µ–µ—Ä–∞
    document.getElementById('play-btn')?.addEventListener('click', () => Player.togglePlay());
    document.getElementById('sync-btn')?.addEventListener('click', () => Player.requestSync());
    document.getElementById('video-overlay')?.addEventListener('click', () => Player.togglePlay());
    
    // –ü–æ–ª–∑—É–Ω–∫–∏
    const seekSlider = document.getElementById('seek-slider');
    if (seekSlider) {
        seekSlider.addEventListener('input', (e) => Player.onSeekInput(e.target.value));
        seekSlider.addEventListener('change', (e) => Player.onSeekChange(e.target.value));
    }
    
    const volumeSlider = document.getElementById('volume-slider');
    if (volumeSlider) {
        volumeSlider.addEventListener('input', (e) => Player.setVolume(e.target.value));
    }
    
    // –í–∏–¥–µ–æ
    document.getElementById('load-video-btn')?.addEventListener('click', () => VideoLoader.loadFromUrl());
    document.getElementById('youtube-example-btn')?.addEventListener('click', () => VideoLoader.loadExample('youtube'));
    document.getElementById('vk-example-btn')?.addEventListener('click', () => VideoLoader.loadExample('vk'));
    
    // –ß–∞—Ç
    document.getElementById('chat-form')?.addEventListener('submit', (e) => Chat.sendMessage(e));
    
    console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
}

// ==========================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¢–†–û–õ–õ–ê–ú–ò –í–ò–î–ï–û
// ==========================================================================

function resetControlsTimer() {
    clearTimeout(controlsTimeout);
    Player.showControls();
    controlsTimeout = setTimeout(() => {
        if (ytPlayer && ytPlayer.getPlayerState && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
            document.getElementById('controls-bar').classList.remove('controls-visible');
            document.getElementById('controls-bar').classList.add('controls-hidden');
        }
    }, 3000);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–æ–≤
document.getElementById('video-wrapper')?.addEventListener('mousemove', resetControlsTimer);
document.getElementById('video-wrapper')?.addEventListener('touchmove', resetControlsTimer);
document.getElementById('controls-bar')?.addEventListener('mousemove', resetControlsTimer);
document.getElementById('controls-bar')?.addEventListener('touchmove', resetControlsTimer);

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
document.addEventListener('dblclick', (e) => {
    if (window.innerWidth <= 768) {
        e.preventDefault();
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
document.getElementById('video-wrapper')?.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.add('translate-x-full');
    }
});

// ==========================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
// ==========================================================================

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube API
window.onYouTubeIframeAPIReady = function() {
    console.log('üé¨ YouTube API –≥–æ—Ç–æ–≤');
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEventListeners);
} else {
    initializeEventListeners();
}

console.log('üéâ Vibeo –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
</script>
</body>
</html>
